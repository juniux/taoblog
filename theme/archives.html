{{define "archives_header"}}
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css" />
<style>
    .archives a {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        max-width: 100%;
    }
</style>
{{end}}

{{define "archives"}}
<div class="archives">
    <div class="tags">
        <h2>标签</h2>
        <ul class=roots>
            {{range .Tags}}
                <li class=tag data-name="{{.Name}}">
                    <i class="tag-name fa fa-tag"></i>
                    <span class="tag-name">{{.Name}}({{.Count}})</span>
                    <ul></ul>
                </li>
            {{end}}
        </ul>
    </div>
    <div class="cats">
        <h2>分类</h2>
        <ul class=roots>
            {{.Cats}}
        </ul>
    </div>
    <div class="date">
        <h2>日期</h2>
        <ul class=roots>
            {{range .Dates}}
                <li class=year-month data-yy={{.Year}} data-mm={{.Month}}>
                    <i class="datetime fa fa-clock-o"></i>
                    <span class="datetime">{{.Year}}年{{.Month | printf "%02d"}}月({{.Count}})</span>
                    <ul></ul>
                </li>
            {{end}}
        </ul>
    </div>
</div>

<script>
function gen_entry(p) {
    return $('<li/>')
        .attr('class', 'title')
        .append($('<a/>')
            .attr('target', '_blank')
            .attr('href', '/' + p.id + '/')
            .attr('title', p.title)
            .text(p.title)
        );
}

function get_entries_callback(ps, ul) {
    for(var i=0; i< ps.length; i++) {
        ul.append(gen_entry(ps[i]));
    }
    if(ps.length == 0) {
        ul.append($('<li/>')
            .attr('class', 'none')
            .text('（没有文章）')
        );
    }
}

function toggle_loading(ul, on) {
    return on
        ? ul.append($('<li/>')
            .attr('class', 'loading')
            .append($('<i/>')
                .attr('class', 'fa fa-cog fa-spin')
                )
            .append($('<span/>').text(' 正在加载...'))
            )
        : ul.find('li.loading').remove()
        ;
}

$('.cats').on('click',function(e) {
    var t = $(e.target);
    if(t.hasClass('folder-name')) {
        var li = t.parent();
        var ul = li.find('>ul');
        var fa = li.find('>.folder-name.fa');
        ul.toggle();
        fa.toggleClass('fa-folder-open-o');
        fa.toggleClass('fa-folder-o');
        if(li.attr('data-clicked') != '1') {
            li.attr('data-clicked', '1');
            toggle_loading(ul, true);
            var cid = li.attr('data-cid');
            $.get('/v1/archives/categories/' + cid,
                function(data) {
                    get_entries_callback(data, ul);
                }
            ).fail(function(x) {
                alert(x.responseText);
            }).always(function() {
                toggle_loading(ul, false);
            });
        }
    }
    e.stopPropagation();
});
$('.date').on('click',function(e) {
    var t = $(e.target);
    if(t.hasClass('datetime')) {
        var li = t.parent();
        var ul = li.find('>ul');
        ul.toggle();
        if(li.attr('data-clicked') != '1') {
            li.attr('data-clicked', '1');
            toggle_loading(ul, true);
            var yy = li.attr('data-yy');
            var mm = li.attr('data-mm');
            $.get('/v1/archives/dates/' + yy + '/' + mm,
                function(data) {
                    get_entries_callback(data, ul);
                }
            ).fail(function(x) {
                alert(x.responseText);
            }).always(function() {
                toggle_loading(ul, false);
            });
        }
    }
    e.stopPropagation();
});
$('.tags').on('click',function(e) {
    var t = $(e.target);
    if(t.hasClass('tag-name')) {
        var li = t.parent();
        var ul = li.find('>ul');
        ul.toggle();
        if(li.attr('data-clicked') != '1') {
            li.attr('data-clicked', '1');
            toggle_loading(ul, true);
            var name = li.attr('data-name');
            $.get('/v1/archives/tags/' + encodeURI(name),
                function(data) {
                    get_entries_callback(data, ul);
                }
            ).fail(function(x) {
                alert(x.responseText);
            }).always(function() {
                toggle_loading(ul, false);
            });
        }
    }
    e.stopPropagation();
});
</script>
{{end}}

{{define "archives_footer"}}

{{end}}
